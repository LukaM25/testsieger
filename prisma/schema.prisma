generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String               @id @default(cuid())
  name                String
  email               String               @unique
  passwordHash        String
  address             String?
  createdAt           DateTime             @default(now())
  company             String?
  orders              Order[]
  products            Product[]
  passwordResetTokens PasswordResetToken[]
  assets              Asset[]
}

model Product {
  id             String          @id @default(cuid())
  userId         String
  name           String
  brand          String
  category       String?
  code           String?
  specs          String?
  size           String?
  madeIn         String?
  material       String?
  status         ProductStatus   @default(PRECHECK)
  adminProgress  AdminProgress   @default(PRECHECK)
  paymentStatus  PaymentStatus   @default(UNPAID)
  processNumber  String?         @unique
  createdAt      DateTime        @default(now())
  certificate    Certificate?
  license        License?
  orders         Order[]
  assets         Asset[]
  completionJobs CompletionJob[]
  user           User            @relation(fields: [userId], references: [id])
  audits         AdminAudit[]

  @@index([name])
  @@index([brand])
  @@index([category])
}

model Order {
  id              String    @id @default(cuid())
  userId          String
  productId       String
  plan            Plan
  priceCents      Int
  stripeSessionId String?   @unique
  stripeSubId     String?
  createdAt       DateTime  @default(now())
  paidAt          DateTime?
  product         Product   @relation(fields: [productId], references: [id])
  user            User      @relation(fields: [userId], references: [id])
  license         License?
}

model Certificate {
  id                  String    @id @default(cuid())
  productId           String    @unique
  pdfUrl              String
  qrUrl               String
  reportUrl           String?
  createdAt           DateTime  @default(now())
  seal_number         String    @unique @default(uuid())
  externalReferenceId String?   @unique
  ratingScore         String?
  ratingLabel         String?
  sealUrl             String?
  product             Product   @relation(fields: [productId], references: [id])
  snapshotData        Json? // Added via SQL
  lastSentAt          DateTime? // Added via SQL
  status              String    @default("PENDING") // Added via SQL
  assets              Asset[]

  license License?

  @@index([seal_number])
}

model License {
  id            String        @id @default(cuid())
  productId     String        @unique
  certificateId String?       @unique
  orderId       String?       @unique
  plan          Plan
  status        LicenseStatus @default(PENDING)
  licenseCode   String        @unique
  stripePriceId String?
  stripeSubId   String?
  paidAt        DateTime?
  startsAt      DateTime
  expiresAt     DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  product     Product      @relation(fields: [productId], references: [id])
  certificate Certificate? @relation(fields: [certificateId], references: [id])
  order       Order?       @relation(fields: [orderId], references: [id])
  assets      Asset[]
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])

  @@index([expiresAt])
}

model Asset {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  type        AssetType
  key         String    @unique
  contentType String
  sizeBytes   Int?
  sha256      String? // optional integrity field

  userId        String?
  productId     String?
  certificateId String?
  licenseId     String?

  user        User?        @relation(fields: [userId], references: [id])
  product     Product?     @relation(fields: [productId], references: [id])
  certificate Certificate? @relation(fields: [certificateId], references: [id])
  license     License?     @relation(fields: [licenseId], references: [id])

  @@index([userId])
  @@index([productId])
  @@index([certificateId])
  @@index([licenseId])
  @@index([type])
}

model Admin {
  id           String     @id @default(cuid())
  email        String     @unique
  name         String
  passwordHash String
  role         AdminRole  @default(EXAMINER)
  active       Boolean    @default(true)
  revokedAt    DateTime?
  lastLoginAt  DateTime?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  audits AdminAudit[]
}

model AdminAudit {
  id         String   @id @default(cuid())
  adminId    String
  action     String
  entityType String?
  entityId   String?
  productId  String?
  payload    Json?
  createdAt  DateTime @default(now())

  admin   Admin   @relation(fields: [adminId], references: [id])
  product Product? @relation(fields: [productId], references: [id])

  @@index([adminId])
  @@index([productId])
  @@index([createdAt])
}

model CompletionJob {
  id            String              @id @default(cuid())
  productId     String
  certificateId String?
  status        CompletionJobStatus @default(PENDING)
  attempts      Int                 @default(0)
  lastError     String?
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  product Product @relation(fields: [productId], references: [id])

  @@index([status, createdAt])
  @@index([productId])
}

enum ProductStatus {
  PRECHECK
  PAID
  IN_REVIEW
  COMPLETED
}

enum AdminProgress {
  PRECHECK
  RECEIVED
  ANALYSIS
  COMPLETION
  PASS
  FAIL
}

enum PaymentStatus {
  UNPAID
  PAID
  MANUAL
}

enum Plan {
  BASIC
  PREMIUM
  LIFETIME
  PRECHECK_FEE
  PRECHECK_PRIORITY
}

enum LicenseStatus {
  PENDING
  ACTIVE
  EXPIRED
  CANCELED
}

enum AdminRole {
  VIEWER
  EXAMINER
  SUPERADMIN
}

enum AssetType {
  OFFICIAL_PDF
  UPLOADED_PDF
  CERTIFICATE_QR
  SEAL_IMAGE
  PRODUCT_UPLOAD
  OTHER
}

enum CompletionJobStatus {
  PENDING
  RUNNING
  FAILED
  COMPLETED
}
